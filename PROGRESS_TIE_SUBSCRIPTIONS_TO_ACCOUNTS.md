# Tie Subscriptions to User Accounts (Not Devices)

## User Request
**From Jon:**
"Is there a way we can tie subscriptions to logins instead of revenue cat IDs? Or can we tie revenue cat IDs to subs instead of devices?"

## Problem Statement

**Before this change:**
- Subscriptions were tied to **anonymous device IDs** generated by RevenueCat
- Each device had its own separate subscription
- If user signed in on a new device â†’ lost their subscription
- If user reinstalled app â†’ lost their subscription
- Had to use "Restore Purchases" to recover (doesn't always work)

**This is the standard RevenueCat behavior when no `appUserID` is provided.**

---

## Solution: Tie Subscriptions to Supabase User Accounts

**After this change:**
- Subscriptions are tied to **Supabase user ID** (user account)
- Same subscription works across ALL devices where user is signed in
- Sign in on new device â†’ subscription automatically available
- Reinstall app and sign in â†’ subscription automatically restored
- **One subscription per user account, not per device**

---

## How It Works

### 1. RevenueCat Configuration

**Updated `initializePurchases()` in `src/utils/entitlements.js`:**
```javascript
// BEFORE (anonymous device ID)
await Purchases.configure({ apiKey });

// AFTER (user account ID)
await Purchases.configure({ 
  apiKey,
  appUserID: supabaseUser.id  // Ties subscription to this user
});
```

**When user signs in:**
- RevenueCat is configured with their Supabase user ID
- All purchases are tied to this ID
- ID travels with the user across devices

**When in guest mode:**
- No user ID provided â†’ falls back to anonymous device ID
- Works same as before for guests

### 2. Sign Out Handling

**Updated `AccountScreen.tsx` handleSignOut:**
```javascript
// Log out from RevenueCat (resets to anonymous)
await logoutRevenueCat();

// Log out from Supabase
await signOut();
```

**Why this matters:**
- Clears the user ID from RevenueCat
- Next launch will be anonymous until user signs in again
- Prevents subscription leakage to next user on shared device

### 3. New RevenueCat Functions

**Added to `src/utils/entitlements.js`:**

**`loginRevenueCat(appUserId)`**
- Explicitly logs in to RevenueCat with a user ID
- Useful for migrating existing anonymous users to user accounts
- Called automatically when user signs in

**`logoutRevenueCat()`**
- Logs out from RevenueCat (resets to anonymous)
- Called when user signs out from app
- Ensures subscription doesn't persist to next user

---

## What This Means for Existing Users

### Scenario 1: User Has Subscription on Current Device
**What happens:**
1. User updates to new app version
2. User is already signed in with Supabase account
3. On next launch, RevenueCat initializes with their user ID
4. RevenueCat sees existing purchase on this device
5. **Purchase is now tied to their Supabase user ID**
6. **Subscription now works on all their devices** âœ…

**Migration happens automatically!** No action needed from user.

### Scenario 2: User Has Subscription but Signs In on New Device
**Before:** 
- Signs in on new device
- Subscription doesn't transfer
- Has to "Restore Purchases" (might not work)

**After:**
- Signs in on new device
- RevenueCat initializes with their user ID
- **Subscription automatically available** âœ…
- No restore needed!

### Scenario 3: Guest Mode User
**What happens:**
- No Supabase user ID
- RevenueCat uses anonymous device ID (same as before)
- If they later create an account:
  - Purchases transfer to their account
  - Can access on other devices

### Scenario 4: Multiple Devices (Same User)
**Before:**
- User bought subscription on iPhone
- Signs in on iPad â†’ no subscription
- Has to buy again or restore (might fail)

**After:**
- User bought subscription on iPhone (tied to user ID)
- Signs in on iPad with same account
- **Subscription works immediately** âœ…
- One purchase, infinite devices!

---

## Important Technical Details

### RevenueCat User ID
- **Format:** Supabase UUID (e.g., `a1b2c3d4-e5f6-7890-abcd-ef1234567890`)
- **Scope:** Global across all devices/platforms for this user
- **Persistence:** Survives app reinstall, device change, etc.

### Guest Mode Behavior
- `appUserID` = `null` â†’ RevenueCat generates anonymous ID
- Anonymous ID is device-specific
- If guest later signs up â†’ can transfer purchases to account

### Purchase Restoration
**RevenueCat handles this automatically:**
- User signs in with existing account
- RevenueCat detects purchases tied to this user ID
- Restores entitlements immediately
- No manual "Restore Purchases" button needed (though we can keep it as backup)

### What If User Never Signs In?
- App works in guest mode (same as before)
- RevenueCat uses anonymous device ID
- Subscription tied to device only
- **Encouraging sign-up becomes more valuable** (to unlock cross-device sync)

---

## Benefits

### For Users
1. âœ… **Cross-device sync** - Buy once, use everywhere
2. âœ… **No restore headaches** - Just sign in and it works
3. âœ… **Reinstall protection** - Never lose subscription
4. âœ… **Account portability** - Upgrade device without losing access

### For Business
1. ðŸ“ˆ **Higher perceived value** - "Works on all your devices"
2. ðŸ“ˆ **Fewer support tickets** - No more "lost my subscription"
3. ðŸ“ˆ **Better retention** - Users less likely to cancel
4. ðŸ“ˆ **Encourages sign-up** - Value proposition for creating account

---

## Code Changes Summary

### Files Modified
1. âœ… `src/utils/entitlements.js`
   - Updated `initializePurchases()` to accept `appUserId`
   - Added `loginRevenueCat()` function
   - Added `logoutRevenueCat()` function

2. âœ… `mobile-app/App.js`
   - Pass `supabaseUser.id` when initializing RevenueCat
   - Handle guest mode (null user ID)
   - Re-initialize when user changes

3. âœ… `src/screens/AccountScreen.tsx`
   - Added RevenueCat logout on sign out
   - Import `logoutRevenueCat` function

---

## Testing Recommendations

**Test 1: New User Sign Up**
1. Fresh install, create account
2. Purchase subscription
3. Sign out, sign back in
4. âœ… Subscription should still be active

**Test 2: Cross-Device**
1. Sign in on Device A
2. Purchase subscription
3. Sign in on Device B with same account
4. âœ… Subscription should be active on Device B

**Test 3: Guest Mode**
1. Use app without signing in
2. Purchase subscription
3. âœ… Should work (tied to device)
4. Later create account
5. âœ… Should transfer to account

**Test 4: Sign Out / Sign In**
1. User with subscription signs out
2. Different user signs in on same device
3. âœ… New user should NOT have old user's subscription
4. Original user signs back in
5. âœ… Should have their subscription back

---

## Migration Plan

**Automatic Migration:**
- No database changes needed
- No API updates needed
- RevenueCat handles everything server-side
- Users with existing purchases will migrate automatically on next app launch

**Rollout:**
1. Deploy code changes
2. Monitor RevenueCat dashboard for user ID usage
3. Support team: inform about new cross-device behavior
4. Update marketing: "Use on all your devices!"

---

## Status
âœ… **COMPLETE** - Subscriptions now tied to user accounts, not devices. Cross-device sync enabled!
